---
- name: Load host definitions
  include_vars: host_vars/support.yml

- name: Wipe temporary directory for template fragments
  file:
    path=/tmp/host
    state={{ item }}
  with_items:
    - absent
    - directory

- name: Upload Support host fragment
  template:
    src=templates/host.cfg.j2
    dest=/tmp/host/host
  with_items:
    - "{{ host }}"

- name: Upload service fragments
  template:
    src=templates/service.cfg.j2
    dest=/tmp/host/svc-{{ item.check_command.replace('!','_') }}
  with_items:
    - "{{ apache_service }}"
    - "{{ mysql_service }}"
    - "{{ xmpp_service }}"
    - "{{ root_check }}"
    - "{{ load_check }}"
    - "{{ memory_check }}"

- name: Upload contact fragments
  template:
    src=templates/contact.cfg.j2
    dest=/tmp/host/cnt-{{ item.contact_name.replace(' ','') }}
  with_items:
    - "{{ contacts }}"

- name: Compose host monitoring configuration
  assemble:
    src=/tmp/host
    dest="/usr/local/nagios/etc/objects-extra/Host-{{ remote_hostname }}.cfg"
    delimiter="{{'\n'}}###################################################{{'\n\n'}}"
    owner=nagios
    group=nagios
    mode=0664
